#!/bin/bash

export AWS_DEFAULT_REGION=$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | jq -r '.region') \
IP={{public_ip}}

INSTANCE_ID=$(
  LEADER=$(dig +short fabio.service.consul | head -1)
  aws ec2 describe-instances \
    --filter Name=network-interface.addresses.private-ip-address,Values=$LEADER \
    --query 'Reservations[*].Instances[*].[InstanceId]' \
    --output text
)

# TODO: remove this test
consul kv put update $(($(consul kv get update)+1))

aws ec2 associate-address --public-ip $IP --instance-id $INSTANCE_ID

# TODO: remove this when consul lock testing has concluded
sleep 5
